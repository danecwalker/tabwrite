# Ralph Progress Log
Started: Sun 01/02/2026  3:48:44.10
---

## Codebase Patterns
- API endpoints go in `src/routes/api/{endpoint-name}/+server.ts`
- Use `json()` from `@sveltejs/kit` for JSON responses
- OpenAI client with Groq baseURL: `new OpenAI({ apiKey, baseURL: "https://api.groq.com/openai/v1" })`
- Export `RequestHandler` type from `./$types` for type safety
- Use `env` from `$env/dynamic/private` for environment variables
- Run `bun run check` for typecheck (npm not available in this environment)
- UI components go in `src/lib/components/`
- Use Svelte 5 runes: `$state()` for reactive state, `$props()` for component props, `$effect()` for side effects, `$derived()` for computed values
- Import types from API files: `import type { CitationClaim } from './api/citations/+server'`
- Main page layout uses flex container for editor + sidebar side-by-side
- Editor component uses contenteditable div with DOM manipulation for inline elements (ghost text, highlights)
- For highlighting text at specific indices, use TreeWalker to find text nodes and splitText() to wrap portions
- Use `bind:this` to get component references for calling exported functions
- Interfaces should NOT use `export` keyword inside regular Svelte script tags
- When working with contenteditable and inline elements, exclude non-content elements (citations, ghost text) from text/index calculations

---

## 2026-02-01 - US-001
- What was implemented:
  - Created POST /api/citations endpoint for citation detection
  - Accepts essay text and analyzes for citation-worthy claims using LLM
  - Returns array of `{ claim, searchQuery, startIndex, endIndex }`
  - Uses LLM to identify statistics, factual claims, and quotations
  - Validates and corrects indices by finding actual text positions
- Files changed:
  - src/routes/api/citations/+server.ts (new file)
- **Learnings for future iterations:**
  - LLM may return incorrect indices, so we verify by finding the actual substring position
  - Export types from API files (e.g., `CitationClaim`) for use in UI components
  - Groq API model used: `llama-3.1-8b-instant`
  - The system uses Svelte 5 with SvelteKit 2
---

## 2026-02-01 - US-002
- What was implemented:
  - Created POST /api/citations/search endpoint for finding academic sources
  - Accepts a query string and uses LLM to generate plausible academic citations
  - Returns array of `{ title, authors, year, url, relevance }`
  - Returns 3-5 citation suggestions per query
  - Validates response structure with proper TypeScript type guards
- Files changed:
  - src/routes/api/citations/search/+server.ts (new file)
- **Learnings for future iterations:**
  - Nested API routes work with directories: `/api/citations/search` lives in `src/routes/api/citations/search/+server.ts`
  - Export `CitationSuggestion` type for UI components to consume
  - Higher temperature (0.7) used for more varied citation suggestions vs lower (0.2) for detection
---

## 2026-02-01 - US-003
- What was implemented:
  - Created CitationSidebar.svelte component for displaying citation suggestions
  - Sidebar appears on the right side of the editor in a flex layout
  - Shows list of detected claims with numbered badges
  - Each claim displays suggested sources with title, authors, year, and relevance
  - Sidebar is scrollable (overflow-y: auto) when content overflows
  - Clean minimal design with light grays, serif font, and subtle borders matching editor aesthetic
  - Includes loading states for detection and source fetching
  - Empty state with helpful text when no claims detected
- Files changed:
  - src/lib/components/CitationSidebar.svelte (new file)
  - src/routes/+page.svelte (modified to include sidebar in flex layout)
- **Learnings for future iterations:**
  - Svelte 5 props use `let { propName }: Props = $props()` syntax
  - For keyed each blocks with objects, use a unique identifier like `startIndex` or `url`
  - Interface for component props should be defined and destructured from `$props()`
  - The sidebar state (claims, isDetecting) is managed in the parent page component
---

## 2026-02-01 - US-004
- What was implemented:
  - Added citation highlighting in the Editor component
  - Claims needing citations are highlighted with a light yellow underline effect
  - Clicking highlighted text scrolls the sidebar to the corresponding claim
  - Added activeClaimIndex state to track which claim is selected
  - Sidebar claim items show an active state when highlighted text is clicked
  - Highlights are applied/updated via $effect when claims prop changes
- Files changed:
  - src/lib/components/Editor.svelte (added highlighting logic, props for claims and callbacks)
  - src/lib/components/CitationSidebar.svelte (added activeClaimIndex prop, scroll-to functionality, active styling)
  - src/routes/+page.svelte (wired up claims to editor, added click handler)
- **Learnings for future iterations:**
  - Use TreeWalker to iterate over text nodes when applying highlights at specific indices
  - Apply highlights from end to beginning (descending startIndex) to avoid index shifting
  - Use CSS `background: linear-gradient(to bottom, transparent 85%, #fef08a 85%)` for underline effect
  - `$effect` in Svelte 5 runs when reactive dependencies change, good for DOM manipulation
  - Split text nodes with `node.splitText(offset)` to wrap partial text in highlight spans
  - Export functions from Svelte 5 components with `export function` for parent access
---

## 2026-02-01 - US-005
- What was implemented:
  - Added "Add" button to each citation suggestion in the sidebar
  - Clicking "Add" inserts an inline citation marker [n] at the end of the claim text
  - Created insertCitationAtIndex() function in Editor to insert citations at specific positions
  - Added bibliography state management in +page.svelte with BibliographyEntry type
  - Citation numbers auto-increment based on bibliography.length + 1
  - After adding a citation, the claim is removed from claimsWithSuggestions (removing its highlight)
  - Styled inline citations as superscript purple markers (non-editable spans)
- Files changed:
  - src/lib/components/CitationSidebar.svelte (added onAddCitation prop, Add button with styling)
  - src/lib/components/Editor.svelte (added insertCitationAtIndex export function, inline-citation CSS)
  - src/routes/+page.svelte (added bibliography state, handleAddCitation handler, editorRef binding)
- **Learnings for future iterations:**
  - Use `bind:this` to get reference to Svelte 5 components for calling exported functions
  - Set `contentEditable="false"` on inline citation spans to prevent user editing
  - Remove claims from state array to automatically remove their highlights (reactive updates)
  - Interfaces in Svelte 5 should NOT use `export` keyword inside regular script tag
---

## 2026-02-01 - US-006
- What was implemented:
  - Created Bibliography.svelte component for displaying formatted citation list
  - Bibliography appears below the editor area with a clean, numbered list format
  - Each entry shows: [n] Author(s). Title (linked). Year. URL
  - Delete button (Ã—) allows removing citations from the bibliography
  - When a citation is removed, remaining citations are renumbered in both bibliography and editor
  - Added updateCitationNumbers() and removeCitationByNumber() exports to Editor component
  - handleRemoveCitation() in page component manages the full removal/renumbering flow
- Files changed:
  - src/lib/components/Bibliography.svelte (new file)
  - src/lib/components/Editor.svelte (added updateCitationNumbers and removeCitationByNumber exports)
  - src/routes/+page.svelte (added Bibliography component, EditorRef interface, handleRemoveCitation handler)
- **Learnings for future iterations:**
  - Query inline-citation elements with querySelectorAll and iterate to update/remove citation markers
  - Use Map<number, number> for old-to-new number mapping when renumbering citations
  - Mutate array entries in place before reassigning to state variable for proper reactivity
  - Export multiple functions from components for different operations (insert, update, remove)
---

## 2026-02-01 - US-007
- What was implemented:
  - Created `createCitationDetector()` utility with 2-second debounce for citation detection
  - Tracks `lastSentText` to skip API calls when text hasn't changed
  - Cancels pending timeouts and aborts in-flight requests when user continues typing
  - Added `onTextChange` prop to Editor component to notify parent of text changes
  - Integrated detection flow in +page.svelte with `handleTextChange()` and `handleDetectionComplete()`
  - Automatically fetches suggestions for each detected claim using AbortController
  - Loading indicator ("Scanning...") appears in sidebar while detection is in progress
- Files changed:
  - src/lib/debounce.ts (added createCitationDetector with debounce, cancel, and reset methods)
  - src/lib/components/Editor.svelte (added onTextChange prop, calls it in handleInput)
  - src/routes/+page.svelte (added citation detector, text change handler, suggestion fetching)
- **Learnings for future iterations:**
  - Use AbortController with fetch signal for cancellable API requests
  - Pattern: Create utility functions that return objects with methods (detect, cancel, reset) for stateful operations
  - Debounced detectors should track lastSentText to avoid redundant calls
  - Pass AbortSignal through to child fetch calls for proper cascading cancellation
  - The sidebar already had isDetecting display logic from US-003, just needed to wire it up
---

## 2026-02-01 - US-008
- What was implemented:
  - Fixed citation persistence during text edits by excluding inline citations from text content calculations
  - Updated all TreeWalker filters to skip inline-citation spans when computing text offsets
  - Added INLINE_CITATION_CLASS constant for consistency across the codebase
  - Added getInlineCitationCount() and getInlineCitationNumbers() exports for state verification
  - Updated EditorRef interface to include new citation query functions
  - Citations now survive text edits without index corruption
- Files changed:
  - src/lib/components/Editor.svelte (updated getTextContent, TreeWalker filters, added citation query functions)
  - src/routes/+page.svelte (updated EditorRef interface)
- **Learnings for future iterations:**
  - When working with contenteditable and inline elements (like citation markers), exclude them from text content calculations
  - TreeWalker filters must skip all non-content elements (ghost text, citations) to maintain consistent indices
  - Use constants for CSS class names to avoid typos and enable easier refactoring
  - Adding utility exports for state verification helps with debugging and future export/import features
---
